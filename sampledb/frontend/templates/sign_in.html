{% extends "base.html" %}

{% block title %}{{ _('Sign In') }} â€” {{ service_name }}{% endblock %}

{# hide user area in navbar #}
{% block navbar_userarea %}
  {% if is_for_refresh %}
  {{ super() }}
  {% endif %}
{% endblock %}

{% block content %}
  <h1 class="text-center">{{ _('Sign in to %(service_name)s', service_name=service_name) }}</h1>
  {% if is_for_refresh %}
  <div class="help-block text-center">{{ _('To ensure the security of your account information, please sign in again.') }}</div>
  {% else %}
  <div class="help-block text-center">
    {% if is_ldap_configured %}
    {{ _('If you have an LDAP account, you can use your LDAP username to sign in. Otherwise, if you do not have a %(service_name)s account yet, please ask another user for an invitation.', service_name=service_name) }}
    {% else %}
    {{ _('If you do not have a %(service_name)s account yet, please ask another user for an invitation.', service_name=service_name) }}
    {% endif %}
  </div>
  {% endif %}
  <div style="display: flex; align-items: stretch">
    <form class="form-horizontal" method="post" id="form-signin" style=" flex: 1">
      {{ form.csrf_token() }}
      <div class="form-group{% if has_errors %} has-error{% endif %}">
        <label for="input-username" class="col-sm-4 control-label">{{ _('Username / Email') }}</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" id="input-username" name="username" placeholder="{{ _('Username / Email') }}">
        </div>
      </div>
      <div class="form-group{% if has_errors %} has-error{% endif %}">
        <label for="input-password" class="col-sm-4 control-label">{{ _('Password') }}</label>
        <div class="col-sm-8">
          <input type="password" class="form-control" id="input-password" name="password" placeholder="{{ _('Password') }}">
        </div>
      </div>
      {% if not is_for_refresh %}
      <div class="form-group">
        <div class="col-sm-offset-8 col-sm-4">
          <div id="link-request-password-reset">
            <a href="{{ url_for('frontend.user_me_preferences')}}" {% if not has_errors %}style="color:#cccccc;"{% endif %}>{{ _('Forgot your password?')}} </a>
          </div>
        </div>
      </div>
      {% endif %}
      <div class="form-group">
        <div class="col-sm-offset-4 col-sm-8">
          <button type="submit" class="btn btn-primary">{{ _('Sign in') }}</button>
        </div>
      </div>
      <input type="hidden" name="remember_me" value="" />
      <input type="hidden" name="shared_device" value="" />
    </form>
    {% if config['ENABLE_FIDO2_PASSKEY_AUTHENTICATION'] %}
      <div style="border-left: 1px solid #ccc; width: 0; margin: 40px; display: flex; justify-content: center; flex-direction: column">
        <div class="text-muted" style="width: 40px; margin-left:-20px; background: linear-gradient(transparent, white, white, transparent); text-align: center; padding: 40px 0; flex:0">
          {{ _('or') }}
        </div>
      </div>
      <form class="form-horizontal" method="post" id="fido2-authenticate-form" style="text-align: center; flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column">
        <div class="alert alert-danger" role="alert" id="alert-fido2-not-supported" style="display: none">
            <strong>{{ _('Error:') }}</strong> {{ _('Your browser does not support WebAuthn, which is required for using FIDO2 Passkeys in %(service_name)s.', service_name=service_name) }}
        </div>
        {{ passkey_form.hidden_tag() }}
        <div class="help-block"></div>
        <button type="submit" class="btn btn-primary">{{ _('Use Passkey') }}</button>
        <input type="hidden" name="remember_me" value="" />
        <input type="hidden" name="shared_device" value="" />
      </form>
  {% endif %}
  </div>
  {% if not is_for_refresh %}
    <div class="form-group">
      <div class="col-sm-offset-5 col-sm-4">
        <div class="checkbox">
          <label>
            <input type="checkbox" id="input-rememberme"> {{ _('Remember me')}}
          </label>
        </div>
      </div>
      <div class="col-sm-offset-5 col-sm-4">
        <div class="checkbox">
          <label>
            <input type="checkbox" id="input-shared_device" {% if request.cookies.get('SAMPLEDB_SHARED_DEVICE_DEFAULT') %}checked="checked"{% endif %}> {{ _('Shared Device')}}
            <i class="fa fa-question-circle" data-toggle="tooltip" data-placement="top" title="{{ _("You will be signed out after %(idle_sign_out_minutes)s minutes of inactivity.", idle_sign_out_minutes=config["SHARED_DEVICE_SIGN_OUT_MINUTES"]) }}"></i>
          </label>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block template_values %}
  {% do set_template_value("config.enable_fido2_passkey_authentication", config['ENABLE_FIDO2_PASSKEY_AUTHENTICATION']) %}
  {% do set_template_value("fido2_options", dict(options)) %}
  {% do set_template_value("translations.passkey_failed", _('The passkey failed to authenticate with the following error: ')) %}

  {{ super() }}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="module" nonce="{{ generate_inline_script_nonce() }}">
    import {
      get,
      supported,
      parseRequestOptionsFromJSON,
    } from "{{ fingerprinted_static('webauthn-json/js/webauthn-json.browser-ponyfill.js') }}";

    if (window.getTemplateValue('config.enable_fido2_passkey_authentication')) {
      async function authenticate(e) {
        e && e.preventDefault();
        const options = window.getTemplateValue('fido2_options');
        const publicKeyCredentialRequestOptions = parseRequestOptionsFromJSON(options);
        const form = $('#fido2-authenticate-form');
        form.removeClass('has-error');
        updateFormHiddenFields(form);
        const help_bock = form.find('.help-block');
        help_bock.text('');
        try {
          const assertion = await get(publicKeyCredentialRequestOptions);
          form.find('[name="assertion"]').val(JSON.stringify(assertion));
          form[0].submit();
          return true;
        } catch (error) {
          form.addClass('has-error');
          help_bock.text(window.getTemplateValue('translations.passkey_failed') + error)
          return false;
        }
      }

      $(function () {
        if (supported()) {
          $("#fido2-authenticate-form").on('submit', authenticate);
        } else {
          $('#alert-fido2-not-supported').show();
          $('#fido2-authenticate-form button').prop('disabled', true);
        }
      });
    }

    function updateFormHiddenFields(form) {
      if ($('#input-shared_device').prop('checked')) {
        form.find('[name="shared_device"]').val("shared_device");
        form.find('[name="remember_me"]').val("");
      } else {
        if ($('#input-rememberme').prop('checked')) {
          form.find('[name="remember_me"]').val("remember_me");
        } else {
          form.find('[name="remember_me"]').val("");
        }
        form.find('[name="shared_device"]').val("");
      }
    }

    $(function() {
      $('#form-signin').on('submit', function() {
        const form = $('#form-signin');
        updateFormHiddenFields(form);
        return true;
      });

      $('#input-shared_device').on('change', function () {
        Cookies.set('SAMPLEDB_SHARED_DEVICE_DEFAULT', $(this).prop('checked') || "", {sameSite: 'Lax'});
        if ($(this).prop('checked')) {
          $('#input-rememberme').prop('disabled', true).prop('checked', false);
        } else {
          $('#input-rememberme').prop('disabled', false);
        }
      }).trigger('change');
    });
  </script>
{% endblock %}
