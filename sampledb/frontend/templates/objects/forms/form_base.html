{% extends "base.html" %}

{% set form_conditions = [] %}

{% set file_pickers = [] %}

{% set calculations = [] %}

{% block stylesheets %}
  {{ super() }}
  <link rel="stylesheet" href="{{ fingerprinted_static('bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css') }}" />
  <link rel="stylesheet" href="{{ fingerprinted_static('bootstrap-select/css/bootstrap-select.min.css') }}" />
  <link rel="stylesheet" href="{{ fingerprinted_static('bootstrap-tagsinput/css/bootstrap-tagsinput.css') }}" />
  <link rel="stylesheet" href="{{ fingerprinted_static('inscrybmde/css/inscrybmde.min.css') }}" />
{% endblock %}


{% block content %}
  {% if errors_by_title %}
    <div class="alert alert-danger" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      {{ _('The object could not be saved due to an error.') }}
      <input type="checkbox" id="object-form-errors-show-more-input"/>
      <label id="object-form-errors-show-more-label" for="object-form-errors-show-more-input"> {{ _('Show more') }}</label>
      <div id="object-form-errors-show-more-content">
        <ul>
          {% for title in errors_by_title %}
          <li><strong>{{ title}}</strong>: <ul>{% for message in errors_by_title[title] %}<li>{{ message }}</li>{% endfor %}</ul></li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ fingerprinted_static('bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js') }}"></script>
  <script src="{{ fingerprinted_static('bootstrap-select/js/bootstrap-select.min.js') }}"></script>
  <script src="{{ fingerprinted_static('bootstrap-tagsinput/js/bootstrap-tagsinput.min.js') }}"></script>
  <script src="{{ fingerprinted_static('typeahead/js/typeahead.bundle.min.js') }}"></script>
  <script src="{{ fingerprinted_static('inscrybmde/js/inscrybmde.min.js') }}"></script>
  <script src="{{ fingerprinted_static('sampledb/js/conditional_wrapper.js') }}" type="module"></script>
  <script src="{{ fingerprinted_static('sampledb/js/sampledb-load-objects.js') }}"></script>
  <script src="{{ fingerprinted_static('math-js/js/math.min.js') }}"></script>
  <script type="module" nonce="{{ generate_inline_script_nonce() }}">
    // this module exports imported variable into the global namespace, to allow existing non-module code to keep working
    import {
      setUpCalculation
    } from "{{ fingerprinted_static('sampledb/js/calculation.js') }}";
    window.setUpCalculation = setUpCalculation;

    import {
      fileEventHandler
    } from "{{ fingerprinted_static('sampledb/js/sampledb-file-form-handler.js') }}";
    window.fileEventHandler = fileEventHandler;

    import {
      conditionalWrapper
    } from "{{ fingerprinted_static('sampledb/js/conditional_wrapper.js') }}";
    window.conditionalWrapper = conditionalWrapper;

    import {
      setupImageDragAndDrop
    } from "{{ fingerprinted_static('sampledb/js/markdown_image_upload.js') }}";
    window.setupImageDragAndDrop = setupImageDragAndDrop;

    import {
      updateTranslationJSON,
      setTranslationHandler,
      updateTranslationLanguages,
      initMarkdownField,
      updateMarkdownField
    } from "{{ fingerprinted_static('sampledb/js/sampledb-internationalization.js') }}";
    window.updateTranslationJSON = updateTranslationJSON;
    window.setTranslationHandler = setTranslationHandler;
    window.updateTranslationLanguages = updateTranslationLanguages;
    window.initMarkdownField = initMarkdownField;
    window.updateMarkdownField = updateMarkdownField;
  </script>
<script type="text/javascript" nonce="{{ generate_inline_script_nonce() }}">
  window.local_decimal_delimiter = "{{ get_local_decimal_delimiter() }}"
  window.mdeFields = [];
  let initPhase = true;
  let file_names_by_id = {};
  let form_data = {};

  {% if file_names_by_id %}
    file_names_by_id = {{ file_names_by_id | tojson }};
  {% endif %}

  {% if form_data %}
    form_data = {{ form_data | tojson }};
  {% endif %}

  function setObjectFormButtonHandler(button) {
    if ($(button).data('parent-prefix').includes('!')) {
      return;
    }
    switch($(button).data('object-form-button')) {
      case 'array_delete':
        $(button).off('click').on('click', arrayFormDeleteHandler($(button).data('parent-prefix'), $(button).data('element-id'), $(button).data('min-items'), $(button).data('max-items'), false));
        break;
      case 'array_add':
        $(button).off('click').on('click', arrayFormAddHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        break;
      case 'list_array_add':
        $(button).off('click').on('click', arrayFormListAddHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        break;
      case 'list_array_delete':
        $(button).off('click').on('click', arrayFormDeleteHandler($(button).data('parent-prefix'), $(button).data('element-id'), $(button).data('min-items'), $(button).data('max-items'), true));
        break;
      case 'table_array_add':
        $(button).off('click').on('click', arrayFormTableAddHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        break;
      case 'table_array_delete':
        $(button).off('click').on('click', arrayFormDeleteHandler($(button).data('parent-prefix'), $(button).data('element-id'), $(button).data('min-items'), $(button).data('max-items'), false));
        break;
      case 'table_array_copy':
        $(button).off('click').on('click', arrayFormTableCopyHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        break;
      case 'table_col_add':
        $(button).off('click').on('click', tableFormColAddHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        updateTableFormButtons($(button).closest('table'), $(button).data('parent-prefix'));
        break;
      case 'table_col_delete':
        $(button).off('click').on('click', tableFormColDeleteHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        break;
      case 'table_row_add':
        $(button).off('click').on('click', tableFormRowAddHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        break;
      case 'table_row_delete':
        $(button).off('click').on('click', tableFormRowDeleteHandler($(button).data('parent-prefix'), $(button).data('min-items'), $(button).data('max-items')));
        break;
    }
  }

  function setObjectFormButtonHandlers() {
    $('[data-object-form-button]').each(function (_, button) {
      setObjectFormButtonHandler(button);
    });
  }

  $(function () {
    $('form').on('submit', function() {
      $('.array-template').remove();
      $('input').not('[type="file"]').change();
      $('textarea').change();
      $('.col-diff').each(function() {
        const value = Number($(this).data('value'));
        const jsonProps = JSON.stringify({ value: value, button_id: (value >= 0) ? $(this).data('add-id') : $(this).data('delete-id') });
        $(this).val(jsonProps);
      });

      $('.table-interaction').each(function() {
        $(this).val($(this).data('content'));
      });

      $('.typeahead').each(function() {
        $(this).val($(this).typeahead('val'));
      });
    });

    $('.table-interaction').each(function() {
      $(this).data('content', JSON.stringify({ interactions: [] }));
    });

    $('.input-group.date').each(function() {
      $(this).datetimepicker({
        locale: "{{ get_user_language(current_user).lang_code }}",
        format: "{{ get_user_language(current_user).datetime_format_moment }}",
        date: $(this).attr('data-datetime'),
        timeZone: "{{ current_user.timezone }}",
        showTodayButton: true
      });
    });


    $('textarea[data-markdown-textarea="true"]').not('.template-markdown-editor').each(function(_, element) {
      setupImageDragAndDrop(initMarkdownField(element, '100px'));
    });

    $('textarea.plotly-chart-editor').each(function() {
      var jsonStr = $( this ).text();
      try {
        var jsonObj = JSON.parse(jsonStr);
        var jsonPretty = JSON.stringify(jsonObj, null, '\t');
        $( this ).text(jsonPretty);
      }
      catch (e) {
        return;
      }
    });

    var select_language_selectpicker = $('.select-language')
    select_language_selectpicker.on('changed.bs.select', function() {
      updateSelectLanguage(this);
    })
    select_language_selectpicker.each(function(_, selectpicker) {
      updateSelectLanguage(selectpicker);
    });

    {% for form_condition in form_conditions %}
      conditionalWrapper("{{ form_condition['id_prefix'] }}", {{ form_condition['conditions'] | encode_choices | tojson }});
    {% endfor %}

    setObjectFormButtonHandlers()

    {% for file_picker in file_pickers %}
      document.getElementById('{{ file_picker["id_prefix"] }}_file').addEventListener('change', window.fileEventHandler('{{ file_picker["id_prefix"] }}', '{{ file_picker["context_id_token"] }}', '{{ url_for(".temporary_file_upload") }}'));
    {% endfor %}

    {% for add_action, button_id in applied_add_actions.items() %}
      $('[id="{{ button_id }}"]').click();
    {% endfor %}

    {% for delete_action, button_id in applied_delete_actions.items() %}
      $('[id="{{ button_id }}"]').click();
    {% endfor %}
    initPhase = false;

    {% for table_interaction_field, actions in applied_table_interaction.items() %}
    (function(){
      const actions = JSON.parse({{ actions | tojson }});
      for(let action of actions.interactions) {
        $(`[id="${action}"]`).click();
      }
    })();
    {% endfor %}

    updateJSInteractiveFields();
    insertFormData();
    replaceMarkdownTemplates();
    showErrors();

    $('select.file-select').each(function() {
      if($(this).parents('.array-template').length > 0) return;
      const name = $(this).attr('name');
      if(form_data[name]) {
        const value = form_data[name]
        const option = $('<option></option>');
        option.attr('value', value);
        option.attr('data-sampledb-temporary-file', '1');
        option.text(file_names_by_id[value][0]);
        $(this).append(option)
        $(this).prop('disabled', false);
        $(this).selectpicker('refresh');
        $(this).selectpicker('val', form_data[name]);
        $(this).selectpicker('refresh');
      }
    })

    $.each(window.conditionalWrapperScripts, function () {
      this();
    });

    window.conditionalWrapperScripts = [];

    setUpCalculations();

    $('div.objectpicker').each(function () {
      let filter_button = $('<button type="button" class="btn btn-default objectpicker-filter-button"  data-toggle="tooltip" data-placement="left" title="{{ _('Filter by Action…') }}"><i class="fa fa-filter"></i></button>');
      $(this).append(filter_button);
      let objectpicker = $(this).find('.selectpicker');
      let actionpicker = $(this).next('.objectpicker-actionpicker').find('.selectpicker');
      filter_button.tooltip();
      filter_button.on('click', function() {
        actionpicker.selectpicker('toggle');
      });
      actionpicker.on('hidden.bs.select', function() {
        let action_id = actionpicker.selectpicker('val');
        if (action_id === "") {
          objectpicker.find('option').prop('disabled', false);
        } else {
          objectpicker.find('option').prop('disabled', true);
          objectpicker.find('option[data-action-id="' + action_id+ '"]').prop('disabled', false);
        }
        objectpicker.find('option[value=""]').prop('disabled', false);
        objectpicker.selectpicker('refresh');
        objectpicker.selectpicker('toggle');
        if (objectpicker.selectpicker('val') === null) {
          objectpicker.selectpicker('val', '');
        }
      });
    });
  });

  function updateSelectLanguage(selectpicker) {
    var enabled_languages = $(selectpicker).selectpicker('val');
    if (!Array.isArray(enabled_languages)) {
      return;
    }
    if (enabled_languages === '' || enabled_languages.length === 0) {
      enabled_languages = ['en'];
    } else {
      enabled_languages.push('en');
    }
    var parent_form_group = $(selectpicker).closest('.form-group');
    {% for language in languages %}
      if (enabled_languages.includes("{{ language.lang_code }}")) {
        parent_form_group.find('[data-sampledb-language-input-for="{{ language.lang_code }}"]').show();
      } else {
        parent_form_group.find('[data-sampledb-language-input-for="{{ language.lang_code }}"]').hide();
      }
    {% endfor %}

    let disabled_languages_error = $('[data-sampledb-disabled-languages-picker="' + selectpicker.id + '"');
    if (disabled_languages_error.length === 1) {
        let disabled_language_codes = disabled_languages_error.data('sampledbDisabledLanguagesCodes').split(',');
        let all_disabled_languages_removed = true;
        for (let i = 0; i < disabled_language_codes.length; i++) {
            if (enabled_languages.includes(disabled_language_codes[i])) {
                all_disabled_languages_removed = false;
                break;
            }
        }
        if (all_disabled_languages_removed) {
            disabled_languages_error.hide();
        } else {
            disabled_languages_error.show();
        }
    }
  }

  var tags = new Bloodhound({
    initialize: true,
    local: {{ tags | tojson }},
    datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
    queryTokenizer: Bloodhound.tokenizers.whitespace
  });
  $('input[name^=\'object__\'][name$=\'__tags\']').each(function() {
    var tagsinput = $(this);
    tagsinput.tagsinput({
      confirmKeys: [13, 32],
      trimValue: true,
      typeaheadjs: {
        name: 'Tags',
        valueKey: 'name',
        displayKey: 'name',
        source: tags.ttAdapter(),
        templates: {
          'suggestion': function(item) {return '<div>' + item.name + ' (×' + item.uses + ')' + '</div>'}
        }
      }
    });
    tagsinput.on('beforeItemAdd', function(event) {
      var sanitized_tag = event.item.toLowerCase().replace(/\s/g,'').replace(/[^a-z0-9_\-äüöß]/g,'');
      if (event.item !== sanitized_tag) {
        if (!event.options || !event.options.fromHandler) {
          event.cancel = true;
          $(this).tagsinput('add', sanitized_tag, {fromHandler: true});
        }
      }
    });
    $(tagsinput.tagsinput('input')).on('blur', function() {
      var item = $(this).tagsinput('input').val();
      $(this).tagsinput('input').val('');
      item = item.trim();
      if (item) {
        $(this).tagsinput('add', item);
      }
    }.bind(tagsinput));
  });

  function refreshRecipeTooltip(id_prefix, recipes, showTooltip=false) {
    let div = $('#' + id_prefix + '_recipe_div');
    let input = $('#' + id_prefix + '_recipe_input');
    let recipe = recipes[input.val()];
    let changedValues = []
    let recipeName = recipe['name'];
    for (const [_, value] of Object.entries(recipe['property_values'])) {
      changedValues.push(value['title'])
    }
    div.attr('title', recipeName + ' {{ _("sets:") }} ' + changedValues.join(', '));
    div.attr('data-original-title', recipeName + ' {{ _("sets:") }} ' + changedValues.join(', '));
    div.tooltip('hide');
  }

  $('document').ready(function() {$("select[id$='_recipe_input']").change();})

  function applyRecipe(id_prefix, recipes, isTable) {
    let codeMirrors = {};
    $('.CodeMirror').each(function(i, el){
      codeMirrors[el.CodeMirror.getTextArea().name] = el.CodeMirror
    });
    for (const [property, value] of Object.entries(recipes[$('#' + id_prefix + '_recipe_input').val()]['property_values'])) {
      if (!isTable && value['value'] !== null && (value['type'] === 'text' || value['type'] === 'multiline' || value['type'] === 'markdown') && value['value'].constructor === Object) {
        let language_select = $('#' + id_prefix + '_' + property + '_-select-language');
        if (language_select.length == 1) {
          let selected_languages = language_select.val();
          if (selected_languages === '' || selected_languages.length === 0) {
            selected_languages = ['en'];
          } else {
            selected_languages.push('en');
          }
          for (const [lang, _text] of Object.entries(value['value'])) {
            if (selected_languages.indexOf(lang) === -1) {
              selected_languages.push(lang)
            }
          }
          language_select.selectpicker('val', selected_languages);
        }
      }
      switch (value['type']) {
        case 'text':
          if (typeof value['value'] === 'string' || value['value'] instanceof String) {
            if (isTable) {
              $('input[name="' + id_prefix + '_' + property + '__text"]').val(value['value'] || '');
            } else {
              $('input[name="' + id_prefix + '_' + property + '__text_en"]').val(value['value'] || '');
            }
          } else if (value['value'] === null) {
            if (isTable) {
              $('input[name="' + id_prefix + '_' + property + '__text"]').val('');
            } else {
              $('input[name^="' + id_prefix + '_' + property + '__text_"]').val('');
            }
          } else if (value['value'].constructor === Object) {
            if (isTable) {
              $('input[name="' + id_prefix + '_' + property + '__text"]').val(value['value']['en']);
            } else {
              for (const [lang, text] of Object.entries(value['value'])) {
                $('input[name="' + id_prefix + '_' + property + '__text_' + lang + '"]').val(text || '');
              }
            }
          }
          break;
        case 'multiline':
          if (typeof value['value'] === 'string' || value['value'] instanceof String) {
            if (isTable) {
              $('textarea[name="' + id_prefix + '_' + property + '__text"]').val(value['value'] || '');
            } else {
              $('textarea[name="' + id_prefix + '_' + property + '__text_en"]').val(value['value'] || '');
            }
          } else if (value['value'] === null) {
            if (isTable) {
              $('textarea[name="' + id_prefix + '_' + property + '__text"]').val('');
            } else {
              $('textarea[name^="' + id_prefix + '_' + property + '__text_"]').val('');
            }
          } else if (value['value'].constructor === Object) {
            if (isTable) {
              $('textarea[name="' + id_prefix + '_' + property + '__text"]').val(value['value']['en'] || '');
            } else {
              for (const [lang, text] of Object.entries(value['value'])) {
                $('textarea[name="' + id_prefix + '_' + property + '__text_' + lang + '"]').val(text || '');
              }
            }
          }
          break;
        case 'markdown':
          if (!isTable) {
            if (typeof value['value'] === 'string' || value['value'] instanceof String) {
              codeMirrors[id_prefix + '_' + property + '__text_en'].setValue(value['value'] || '');
            } else if (value['value'] === null) {
              for (let name in codeMirrors) {
                if (name.startsWith(id_prefix + '_' + property + '__text_')) {
                  codeMirrors[name].setValue('');
                }
              }
            } else if (value['value'].constructor === Object) {
              for (const [lang, text] of Object.entries(value['value'])) {
                codeMirrors[id_prefix + '_' + property + '__text_' + lang].setValue(text || '');
              }
            }
          } else {
            if (typeof value['value'] === 'string' || value['value'] instanceof String || value['value'] === null) {
              $('textarea[name="' + id_prefix + '_' + property + '__text"]').val(value['value'] || '');
            } else if (value['value'].constructor === Object) {
              $('textarea[name="' + id_prefix + '_' + property + '__text"]').val(value['value']['en'] || '');
            }
          }
          break;
        case 'choice':
          let selectpicker = $('select[name="' + id_prefix + '_' + property + '__text"]');
          selectpicker.val(value['value'] || '');
          selectpicker.selectpicker('refresh');
          break;
        case 'quantity':
          $('input[name="' + id_prefix + '_' + property + '__magnitude"]').val(value['value'] || '');
          if (value['units']) {
            $('select[name="' + id_prefix + '_' + property + '__units"]').selectpicker('val', value['units']);
          }
          break;
        case 'bool':
          $('input[name="' + id_prefix + '_' + property + '__value"]').prop('checked', value['value']);
          break;
        case 'datetime':
          $('input[name="' + id_prefix + '_' + property + '__datetime"]').val(value['value'] || '');
          break;
      }
    }
  }

  function updateArrayButtons(addButton, copyButtons, deleteButtons, minItems, maxItems) {
      let current_length = deleteButtons.length - 1;
      deleteButtons.prop('disabled', current_length <= minItems);
      if(addButton) addButton.prop('disabled', maxItems !== -1 && current_length >= maxItems);
      if(copyButtons.length > 0) copyButtons.prop('disabled', maxItems !== -1 && current_length >= maxItems);
  }

  function arrayFormListAddHandler(parent_prefix, minItems, maxItems) {
    return function() {
      const array = $(`#array-${parent_prefix}`);
      const index_order_placeholder = `!index${$(array).data('template-order-index')}!`;
      let template = $(`#template-${parent_prefix}`);
      let clone = $(`#template-${parent_prefix} > div`).clone(true);
      let element_id = Number(template.data('next-id'));

      replaceTemplateIndex(clone, index_order_placeholder, element_id);
      template.before(clone);

      let delete_button = $(`#action_${parent_prefix}_${element_id}__delete`);
      delete_button.data("element-id", element_id);
      delete_button.attr("data-element-id", element_id);
      setObjectFormButtonHandler(delete_button[0]);
      $(array).append(`<input type="hidden" value="action_${parent_prefix}_?__add" name="applied_action__${parent_prefix}_${element_id}__add">`);
      template.data('next-id', element_id + 1);

      let current_length = $(`.container_${parent_prefix}`).length - 1;

      if(current_length === 0) {
        $(`#button_${parent_prefix}_width`).removeClass('col-md-offset-3');
      } else {
        $(`#button_${parent_prefix}_width`).addClass('col-md-offset-3');
        if(current_length === 1) {
          $(clone).removeClass('col-md-offset-3');
        }
      }

      updateArrayNames(parent_prefix);
      applyInteractionModifications(clone, $(this), [], $(`.action_delete_${parent_prefix}`), minItems, maxItems);
      if(!initPhase) replaceMarkdownTemplates();
    }
  }

  function applyInteractionModifications(clone, addButton, copyButtons, deleteButton, minItems, maxItems) {
      updateJSInteractiveFields();
      applySchemaConditions(clone);
      applySchemaCalculations(clone);
      updateLanguageSelects(clone);
      updateRecipeState(clone);
      updateArrayButtons(addButton, copyButtons, deleteButton, minItems, maxItems);

      clone.find('.form-add-button').each(function() {
        if($(this).parents('.array-template').length === 0) {
          setObjectFormButtonHandler(this);
        }
      });

      updateButtonsForDefaultItems(clone);
      generateMinOrDefaultElements(clone);
  }

  function updateButtonsForDefaultItems(clone) {
    clone.find('[data-is-default="default"]').each(function() {
      const parent_prefix = $(this).data('parent-prefix');
      if ($(this).attr('id').endsWith('__copy')) {
        $(this).off('click').on('click', arrayFormTableCopyHandler(parent_prefix, $(this).data('min-items'), $(this).data('max-items')));
      } else {
        $(this).off('click').on('click', arrayFormDeleteHandler(parent_prefix, $(this).data('element-id'), $(this).data('min-items'), $(this).data('max-items'), $(this).data('is-default') === 'list'));
      }
      updateArrayButtons(null, [], $(`.action_delete_${parent_prefix}`), $(this).data('min-items'), $(this).data('max-items'));
    });
    clone.find('[data-array-kind="table"]').not('[data-is-default="default"]').each(function() {
      if($(this).parents('.array-template').length > 0) return;
      if($(this).data('is-default') === "row-add") {
        $(this).off('click').on('click', tableFormRowAddHandler($(this).data('id-prefix'), $(this).data('min-items'), $(this).data('max-items')));
      } else if($(this).data('is-default') === "row-delete") {
        $(this).off('click').on('click', tableFormRowDeleteHandler($(this).data('id-prefix')));
      } else if($(this).data('is-default') === "col-add") {
        $(this).off('click').on('click', tableFormColAddHandler($(this).data('id-prefix'), $(this).data('min-items'), $(this).data('max-items')));
      } else if($(this).data('is-default') === "col-delete") {
        $(this).off('click').on('click', tableFormColDeleteHandler($(this).data('id-prefix')));
      }
      updateTableFormButtons($(this).closest('table'), $(this).data('id-prefix'));
    })
  }

  function clearUnusedConditions() {
      if (window.conditionalWrapperConditions) {
        for (const id_prefix of Object.keys(window.conditionalWrapperConditions)) {
          if ($(`[data-condition-wrapper-for^=${id_prefix}]`).length === 0) {
            delete window.conditionalWrapperConditions[id_prefix];
          }
        }
      }
  }

  function updateArrayNames(prefix, sorted_array_indices) {
    if (typeof sorted_array_indices !== 'object') {
      const elements = $(`[name^="${prefix}_"]`);
      const used_array_indices = [];
      elements.each(function(_, element) {
        const index_string = element.name.substring(prefix.length + 1).split('_', 1)[0];
        const index = Number.parseInt(index_string);
        if (index.toString() === index_string && !used_array_indices.includes(index)) {
          used_array_indices.push(index);
        }
      });
      // custom comparator to sort numbers numerically instead of lexicographically
      used_array_indices.sort(function(a, b) {
        return a-b;
      });
      sorted_array_indices = used_array_indices;
    }
    for (let i = 0; i < sorted_array_indices.length; i++) {
      const old_prefix = `${prefix}_${sorted_array_indices[i]}_`;
      const tmp_prefix = `updateArrayNames_tmp_prefix_${i}_`;
      $(`[name^="${old_prefix}_"]`).each(function(_, element) {
        element.name = tmp_prefix + element.name.substring(old_prefix.length);
      });
      $(`[name^="applied_action__${old_prefix}_"]`).each(function(_, element) {
        element.name = 'applied_action__' + tmp_prefix + element.name.substring('applied_action__'.length + old_prefix.length);
      });
      for (const data_attribute of ['id-prefix', 'condition-wrapper-for', 'condition-replacement-for']) {
        $(`[data-${data_attribute}^="${old_prefix}_"], [data-${data_attribute}="${old_prefix}"]`).each(function(_, element) {
          $(element).attr(`data-${data_attribute}`, tmp_prefix + $(element).data(data_attribute).substring(old_prefix.length));
          $(element).data(data_attribute, $(element).attr(`data-${data_attribute}`));
        });
      }
      $(`span[id^="${old_prefix}_"][id$="_calculation_help"]`).each(function(_, element) {
        $(element).attr('id', tmp_prefix + $(element).attr('id').substring(old_prefix.length));
      });
      if (window.conditionalWrapperConditions) {
        for (const [id_prefix, conditions] of Object.entries(window.conditionalWrapperConditions)) {
          if (id_prefix.startsWith(old_prefix)) {
            delete window.conditionalWrapperConditions[id_prefix];
            window.conditionalWrapperConditions[tmp_prefix + id_prefix.substring(old_prefix.length)] = conditions;
          }
        }
      }
    }
    for (let i = 0; i < sorted_array_indices.length; i++) {
      const tmp_prefix = `updateArrayNames_tmp_prefix_${i}_`;
      const new_prefix = `${prefix}_${i}_`;
      $(`[name^="${tmp_prefix}_"]`).each(function(_, element) {
        element.name = new_prefix + element.name.substring(tmp_prefix.length);
      });
      $(`[name^="applied_action__${tmp_prefix}_"]`).each(function(_, element) {
        element.name = 'applied_action__' + new_prefix + element.name.substring('applied_action__'.length + tmp_prefix.length);
      });
      for (const data_attribute of ['id-prefix', 'condition-wrapper-for', 'condition-replacement-for']) {
        $(`[data-${data_attribute}^="${tmp_prefix}_"], [data-${data_attribute}="${tmp_prefix}"]`).each(function(_, element) {
          $(element).attr(`data-${data_attribute}`, new_prefix + $(element).data(data_attribute).substring(tmp_prefix.length));
          $(element).data(data_attribute, $(element).attr(`data-${data_attribute}`));
        });
      }
      $(`span[id^="${tmp_prefix}_"][id$="_calculation_help"]`).each(function(_, element) {
        $(element).attr('id', new_prefix + $(element).attr('id').substring(tmp_prefix.length));
      });
      if (window.conditionalWrapperConditions) {
        for (const [id_prefix, conditions] of Object.entries(window.conditionalWrapperConditions)) {
          if (id_prefix.startsWith(tmp_prefix)) {
            delete window.conditionalWrapperConditions[id_prefix];
            window.conditionalWrapperConditions[new_prefix + id_prefix.substring(tmp_prefix.length)] = conditions;
          }
        }
      }
    }
  }

  function arrayFormAddHandler(parent_prefix, minItems, maxItems) {
    return function() {
      let parent = $(`[id="container_${parent_prefix}_elements"]`);
      const index_order_placeholder = `!index${parent.data('template-order-index')}!`;
      let template = parent.children('.array-template').first();
      let clone = $(template.clone(true));
      let element_id = Number(template.data('next-id'));
      clone.removeClass('array-template');
      clone.removeData('next-id');

      replaceTemplateIndex(clone, index_order_placeholder, element_id);

      template.before(clone);
      clone.find(`[id="action_${parent_prefix}_${element_id}__delete"]`).off('click').on('click', arrayFormDeleteHandler(parent_prefix, element_id, minItems, maxItems, false));

      parent.closest('form').append(`<input type="hidden" value="action_${parent_prefix}_?__add" name="applied_action__${parent_prefix}_${element_id}__add">`);
      template.data('next-id', element_id + 1);

      updateArrayNames(parent_prefix);
      applyInteractionModifications(clone, $(this), [], $(`.action_delete_${parent_prefix}`), minItems, maxItems);
      if(!initPhase) replaceMarkdownTemplates();
    }
  }

  function arrayFormTableAddHandler(parent_prefix, minItems, maxItems) {
    return function() {
      let table = $(this).closest('table');
      let clone = table.find('.array-template').clone(true);
      let element_id = Number(table.find('.array-template').data('next-id'));
      const index_order_placeholder = `!index${table.parent().data('template-order-index')}!`;
      clone.removeClass('array-template');
      clone.removeData('next-id');

      replaceTemplateIndex(clone, index_order_placeholder, element_id);

      clone.find(`[id="action_${parent_prefix}_${element_id}__delete"]`).off('click').on('click', arrayFormDeleteHandler(parent_prefix, element_id, minItems, maxItems, false));
      clone.find(`[id="action_${parent_prefix}_${element_id}__copy"]`).off('click').on('click', arrayFormTableCopyHandler(parent_prefix, minItems, maxItems));
      table.find('.array-template').before(clone);
      table.find('.array-template').data('next-id', element_id + 1);

      table.closest('form').append(`<input type="hidden" value="action_${parent_prefix}_?__add" name="applied_action__${parent_prefix}_${element_id}__add">`);

      updateArrayNames(parent_prefix);
      applyInteractionModifications(clone, $(this), table.find('> tbody > tr > td:last-of-type .form-copy-button'), $(`.action_delete_${parent_prefix}`), minItems, maxItems);
    }
  }

  function arrayFormTableCopyHandler(parent_prefix, minItems, maxItems) {
    function getTableRowPrefix(row) {
      const field_prefixes = [];
      // for arrays, there is always at least a "hidden" field, so we can use the prefixes for those fields
      row.find('[name^="object__"][name$="__hidden"]').each(function(_, element) {
        field_prefixes.push(element.name.substring(0, element.name.length - "hidden".length));
      });
      field_prefixes.sort();
      // the shortest prefix is the one for this row, longer ones may be e.g. for a checkbox
      return field_prefixes[0];
    }

    return function() {
      const addButton = $(this).closest('table').find('> tfoot .form-add-button')[0];
      arrayFormTableAddHandler(parent_prefix, minItems, maxItems).bind(addButton)();
      const table_body = $(this).closest('tbody');
      const source_row = $(this).closest('tr');
      const target_row = table_body.find('tr:nth-last-of-type(2)');
      source_row.after(target_row);
      const source_field_prefix = getTableRowPrefix(source_row);
      const target_field_prefix = getTableRowPrefix(target_row);
      const target_fields = target_row.find(`[name^="${target_field_prefix}"]`);
      for (const target_field of target_fields) {
        const source_field_name = source_field_prefix + target_field.name.substring(target_field_prefix.length);
        const source_field = $(`[name=${source_field_name}]`)[0];
        if (source_field.tagName === "INPUT" || source_field.tagName === "TEXTAREA") {
          if (source_field.type === "checkbox") {
            $(target_field).prop('checked', $(source_field).prop('checked'));
          } else {
            $(target_field).val($(source_field).val());
          }
        } else if (source_field.tagName === "SELECT") {
          const source_value = $(source_field).selectpicker('val');
          if ($(target_field).find(`option[value="${source_value}"]`).length === 0) {
            $(target_field).append($(source_field).find('option:selected').clone());
            $(target_field).prop('disabled', $(source_field).prop('disabled'));
            $(target_field).selectpicker('refresh');
          }
          $(target_field).selectpicker('val', $(source_field).selectpicker('val'));
        }
        $(target_field).trigger('change');
      }
      const sorted_row_indices = [];
      for (const row of table_body.find('tr')) {
        const row_prefix = getTableRowPrefix($(row));
        const row_index = row_prefix.split('__').slice(-2)[0];
        if (row_index[0] !== "!") {
          sorted_row_indices.push(Number.parseInt(row_index));
        }
      }
      updateArrayNames(parent_prefix, sorted_row_indices);
    }
  }

  function tableFormColAddHandler(id_prefix) {
    return function () {
      const table = $(this).closest('table');
      const body = table.find('tbody');
      const newHeader = $('<th>');
      const currentLength = table.find('thead').first().find('tr').children().length - 1;
      const templateField = table.find('tbody').first().children('.array-template').filter('[data-template-table-type="col"]').children('td').clone(true);
      const templateRow = body.children('.array-template').filter('[data-template-table-type="row"]');

      updateTableInteraction(id_prefix, $(this).attr('id'));

      newHeader.text(`{{ _('Field %(index)s', index="${currentLength+1}") }}`);
      newHeader.clone().insertBefore(table.children('tfoot').find('.control-buttons'));
      newHeader.clone().insertBefore(table.children('thead').find('.control-buttons'));

      templateField.removeClass('array-col-template');
      let targetRows = table.find('tbody').first().find('tr').not('[data-template-table-type="col"]');

      const rowLengthDiff = templateRow.children().not('.control-buttons').length - currentLength;
      if(rowLengthDiff > 0) {
        targetRows = targetRows.not('[data-template-table-type="row"]');
      }

      targetRows.each(function() {
        const customField = templateField.clone();
        customField.attr('id', customField.attr('id').replaceAll(`!index${table.data('template-order-index')}!`, $(this).data('row-id')));
        replaceTemplateIndex(customField, `!index${table.data('template-order-index')}!`, $(this).data('row-id'));
        replaceTemplateIndex(customField, `!cindex${table.data('col-order-index')}!`, $(this).hasClass('array-template') ? $(this).children('td').not('.control-buttons').length : table.data('col-next-id') );
        customField.insertBefore($(this).children().last());
      });

      updateTableFormButtons(table, id_prefix);
      updateArrayNames(id_prefix);
      updateJSInteractiveFields();
      table.data('col-next-id', table.data('col-next-id') + 1);
    }
  }

  function updateTableInteraction(id_prefix, interactionId) {
    const input = $(`[name="applied_action__${id_prefix}__table_interaction"]`);
    let content = JSON.parse(input.data('content'));
    content.interactions.push(interactionId);
    input.data('content', JSON.stringify(content));
  }

  function tableFormRowAddHandler(id_prefix) {
    return function() {
      const table = $(this).closest('table');
      const head = table.children('thead');
      const body = table.children('tbody');
      const templateRow = body.children('.array-template').filter('[data-template-table-type="row"]');
      let headerSize = head.find('tr').children().not('.control-buttons').length;
      let rowSize = body.find('tr').not('.array-template').length;

      updateTableInteraction(id_prefix, $(this).attr('id'));

      if(rowSize > 0) {
        const rowLengthDiff = templateRow.children().not('.control-buttons').length - headerSize;
        if(rowLengthDiff > 0) {
          for(let i = 0; i < rowLengthDiff; i++) {
            body.children().not('.array-template').each(function() {
              appendFieldToRow($(this), table, $(this).data('row-id'), $(this).children().not('.control-buttons').length + i);
            });
          }
          table.data('col-next-id', templateRow.children().not('.control-buttons').length);
        } else {
          const startLength = templateRow.children().not('.control-buttons').length;
          for(let i = 0; i < -rowLengthDiff; i++) {
            appendFieldToRow(templateRow, table, undefined,  startLength + i);
          }
        }
      }
      const newRow = templateRow.clone();
      newRow.attr('data-row-id', table.data('row-next-id'));
      newRow.removeClass('array-template');
      replaceTemplateIndex(newRow, `!index${table.data('template-order-index')}!`, table.data('row-next-id'));
      newRow.children('.control-buttons').find('button').off('click').on('click', tableFormRowDeleteHandler(id_prefix));
      body.append(newRow);
      table.data('row-next-id', table.data('row-next-id') + 1);
      updateTableFormHead(table, newRow.children().not('.control-buttons').length - headerSize);
      updateTableFormButtons(table, id_prefix);
      updateArrayNames(id_prefix);
      updateJSInteractiveFields();
    }
  }

  function appendFieldToRow(row, table, rowId, colId) {
      const templateField = table.find('tbody').first().children('.array-template').filter('[data-template-table-type="col"]').children('td').clone(true);
      const customField = templateField.clone();

      if(rowId !== undefined) {
        customField.attr('id', customField.attr('id').replaceAll(`!index${table.data('template-order-index')}!`, rowId));
        replaceTemplateIndex(customField, `!index${table.data('template-order-index')}!`, rowId);
      }
      replaceTemplateIndex(customField, `!cindex${table.data('col-order-index')}!`, colId);
      customField.insertBefore(row.children().last());
  }

  function updateTableFormHead(table, diff) {
    const head = table.find('thead > tr');
    const foot = table.find('tfoot > tr');
    if(diff < 0) {
      for(let i = 0; i < -diff; i++) {
        head.children().not('.control-buttons').last().remove();
        foot.children().not('.control-buttons').last().remove();
      }
    } else {
      let nextId = head.children().not('.control-buttons').length + 1;
      const newHeader = $('<th>');
      for(let i = 0; i < diff; i++) {
        newHeader.text(`{{ _('Field %(index)s', index="${nextId}") }}`);
        newHeader.clone().insertBefore(head.children().last());
        newHeader.clone().insertBefore(foot.children().last());
        nextId += 1;
      }
    }
  }

  function replaceTemplateIndex(parentNode, templateReplacement, id) {
    parentNode.attr('id', parentNode.attr('id').replaceAll(templateReplacement, id));
    parentNode.find('*').add(parentNode).each(function() {
      if($(this).attr('id')) $(this).attr('id', $(this).attr('id').replaceAll(templateReplacement, id));
      if($(this).attr('name')) $(this).attr('name', $(this).attr('name').replaceAll(templateReplacement, id));
      if($(this).attr('class')) $(this).attr('class', $(this).attr('class').replaceAll(templateReplacement, id));

      for (const data_attribute of ['parent-prefix', 'name', 'id-prefix', 'condition-wrapper-for', 'condition-replacement-for']) {
        if ($(this).attr(`data-${data_attribute}`)) {
          $(this).attr(`data-${data_attribute}`, $(this).attr(`data-${data_attribute}`).replaceAll(templateReplacement, id));
          $(this).data(data_attribute, $(this).attr(`data-${data_attribute}`));
        }
      }
    });
  }

  function arrayFormDeleteHandler(prefix, id, minItems, maxItems, isListStyle) {
    return function() {
      $(`#action_${prefix}_${id}__delete`).closest("form").append(`<input type="hidden" value="" name="action_${prefix}_${id}___delete">`);
      $(`#action_${prefix}_${id}__delete`).closest("form").append(`<input type="hidden" value="action_${prefix}_${id}__delete" name="applied_action__${prefix}_${id}__delete">`);
      $(`#container_${prefix}_${id}_`).remove();
      let current_length = $(`.action_delete_${prefix}`).length - 1;

      if(isListStyle) {
        if(current_length === 0) {
          $(`#button_${prefix}_width`).removeClass('col-md-offset-3');
        } else {
          $(`#button_${prefix}_${id}_width`).addClass('col-md-offset-3');
          $(`.container_${prefix}`).first().removeClass("col-md-offset-3");
        }
      }
      const addButton = $(`[id="action_${prefix}_?__add"]`);
      let copyButtons = [];
      if (addButton.parent()[0].tagName === 'TH') {
        copyButtons = addButton.closest('table').find('> tbody > tr > td:last-of-type .form-copy-button');
      }
      updateArrayButtons(addButton, copyButtons, $(`.action_delete_${prefix}`), minItems, maxItems);
      updateArrayNames(prefix);
      clearUnusedConditions();
      setUpCalculations();
    }
  }

  function tableFormRowDeleteHandler(id_prefix) {
    return function() {
      const table = $(this).closest('table');
      const rowIndex = $(this).data('row-index');

      updateTableInteraction(id_prefix, $(this).attr('id'));

      $(`[name="${id_prefix}_${rowIndex}__hidden"]`).remove();
      $(this).closest('tr').remove();
      if(table.find('tbody > tr').not('.array-template').length === 0) {
        updateTableFormHead(table, -table.find('thead > tr > th').not('.control-buttons').length);
      }
      updateTableFormButtons(table, id_prefix);
      updateArrayNames(id_prefix);
      clearUnusedConditions();
      setUpCalculations();
    }
  }

  function tableFormColDeleteHandler(id_prefix) {
    return function() {
      const table = $(this).closest('table');

      updateTableInteraction(id_prefix, $(this).attr('id'));

      table.children('thead').children('tr').children().not('.control-buttons').last().remove();
      table.children('tbody').children().not('[data-template-table-type="col"]').each(function() {
        $(this).children().not('.control-buttons').last().remove();
      });
      table.children('tfoot').children('tr').children().not('.control-buttons').last().remove();

      updateTableFormButtons(table, id_prefix);
      table.data('col-next-id', table.data('col-next-id') - 1);
      updateArrayNames(id_prefix);
      clearUnusedConditions();
      setUpCalculations();
    }
  }

  function insertFormData() {
    {% if form_data is not none and form_data|length > 0 %}
    const form_data = {{ form_data | tojson }};

    $.each(form_data, function(key, value) {
      const field = $(`[name=${key}]`);
      if(field.hasClass('objectpicker')) {
        field.data('sampledb-default-selected', value);
      } else if(field.hasClass('choicepicker')) {
        field.data('sampledb-default', value);
        field.selectpicker('val', value);
      } else if(field.parents('.date').length > 0) {
        field.val(value);
      } else if(field.hasClass('typeahead')) {
        field.attr('data-previous-data', value);
      } else if(field.data('markdown-textarea')) {
        field.text(value);
      }
      field.val(value);
    });

    $('[type="checkbox"]').each(function() {
      const name = $(this).attr('name');
      $(this).prop('checked', form_data.hasOwnProperty(name));
    });

    $('.selectpicker').selectpicker('refresh');
    {% endif %}
  }

  function showErrors() {
    {% if errors is not none %}
    const errors = {{ errors | tojson }};
    const form_data = {{ form_data | tojson }};

    $.each(form_data, function(key, value) {
      if(errors.hasOwnProperty(key)) return;
      const errorParent = $(`[name=${key}]`).closest('.error-parent');
      errorParent.addClass('has-success');
    });

    $.each(errors, function(key, value) {
      const errorParent = $(`[name=${key}]`).closest('.error-parent');
      if(errorParent.hasClass('has-success')) errorParent.removeClass('has-success');
      errorParent.addClass('has-error');
      errorParent.find('.error-note').html(`<strong>{{ _('Error:') }} </strong>${value}`);
    });

    {% endif %}
  }

  function generateMinOrDefaultElements(newElem) {
    $(newElem).find('.form-add-button[id$="__?__add"]').each(function() {
      const add_button = $(this);
      if(add_button.parents('.array-template').length === 0 && !initPhase) {
        const array_id_prefix = add_button.attr('id').substring(0, add_button.attr('id').length - '_?__add'.length);
        const minItems = add_button.data('min-items') ? add_button.data('min-items') : 0;
        const defaultItems = add_button.data('default-items') ? add_button.data('defaultItems') : 0;
        for(let i = 0; i < Math.max(minItems, defaultItems); i++) {
          const delete_button = $('#' + array_id_prefix + '_' + i + '__delete');
          if (delete_button.length === 0) {
            add_button.click();
          }
        }
      }
    });
  }

  function updateTableFormButtons(table, id_prefix) {
    const rowLength = table.children('tbody').find('.delete-row-button').length - 1;
    const headLength = table.children('thead').find('tr').children().not('.control-buttons').length;

    const minRows = table.data('min-rows');
    const maxRows = table.data('max-rows');
    const minCols = table.data('min-cols');
    const maxCols = table.data('max-cols');

    const addColumn = table.find('[data-object-form-button="table_col_delete"]');
    const deleteColumn = table.find('[data-object-form-button="table_col_add"]');

    addColumn.prop('disabled', true);

    $('.delete-row-button').prop('disabled', rowLength <= minRows);
    $(`[id="action_add_${id_prefix}"]`).prop('disabled', maxRows !== -1 && rowLength >= maxRows);

    deleteColumn.prop('disabled', headLength <= minCols);
    addColumn.prop('disabled', headLength >= maxCols);

    if(rowLength === 0) {
      addColumn.prop('disabled', true);
      deleteColumn.prop('disabled', true);
      table.find('thead > tr > *:not(.control-buttons)').remove();
      table.find('tfoot > tr > *:not(.control-buttons)').remove();
    } else {
      addColumn.prop('disabled', maxCols !== -1 && headLength >= maxCols);
      deleteColumn.prop('disabled', !(headLength > minCols));
    }
  }

  function updateLanguageSelects(clone) {
    clone.find('select').each(function() {
      if($(this).hasClass('select-language')) {
        $(this).on('changed.bs.select', function() {
          updateSelectLanguage(this);
        });

        updateSelectLanguage($(this));
      }
    });
  }

  function addActionFilterButton(picker) {
    let filter_button = $('<button type="button" class="btn btn-default objectpicker-filter-button"  data-toggle="tooltip" data-placement="left" title="{{ _('Filter by Action…') }}"><i class="fa fa-filter"></i></button>');
    picker.append(filter_button);
    let objectpicker = picker.find('.selectpicker');
    let actionpicker = picker.next('.objectpicker-actionpicker');

    filter_button.tooltip();
    filter_button.on('click', function() {
      actionpicker.selectpicker('toggle');
    });
    actionpicker.on('hidden.bs.select', function() {
      let action_id = actionpicker.selectpicker('val');
      if (action_id === "") {
        objectpicker.find('option').prop('disabled', false);
      } else {
        objectpicker.find('option').prop('disabled', true);
        objectpicker.find('option[data-action-id="' + action_id + '"]').prop('disabled', false);
      }
      objectpicker.find('option[value=""]').prop('disabled', false);
      objectpicker.selectpicker('refresh');
      objectpicker.selectpicker('toggle');
      if (objectpicker.selectpicker('val') === null) {
        objectpicker.selectpicker('val', '-');
      }
    });
  }

  function updateJSInteractiveFields() {
    let objectpickers = [];
    $('.template-select').each(function() {
      if($(this).parents('.array-template').length === 0) {
        $(this).attr('class', $(this).data('template-class'));
        $(this).removeData('template-class');
        if($(this).hasClass('objectpicker')) objectpickers.push($(this));
      }
    });

    $('.template-file-select').each(function() {
      if($(this).parents('.array-template').length === 0) {
        const parent = $(this).parent();
        const input = parent.find('input:file');
        $(this).attr('class', $(this).data('template-class'));
        $(this).selectpicker();
        input.change(window.fileEventHandler(input.data('id-prefix'), input.data('context-id-token'), "{{ url_for('.temporary_file_upload') }}"));
      }
    });

    $('.template-typeahead-container').each(function() {
      if($(this).parents('.array-template').length === 0) {
        $(this).removeClass('template-typeahead-container');
        $(this).addClass('objectpicker-container');
        let inputChild = $(this).find('.template-typeahead');
        inputChild.removeClass('template-typeahead');
        inputChild.addClass('typeahead');
      }
    });

    $('.date-template').each(function() {
      if($(this).parents('.array-template').length === 0) {
        $(this).removeClass('date-template');
        $(this).addClass('date');
        $(this).datetimepicker({
          locale: "{{ get_user_language(current_user).lang_code }}",
          format: '{{ get_user_language(current_user).datetime_format_moment }}',
          date: $(this).attr('data-datetime'),
          timeZone: "{{ current_user.timezone }}",
          showTodayButton: true
        });
      }
    });

    $('.objectpicker').each(function() {
      $(this).data('sampledb-default-selected', $(this).val());
    })

    updateObjectPickers();

    $.each(objectpickers, function() {
      if($(this).closest('.error-parent').find('.objectpicker-filter-button').length === 0) {
        addActionFilterButton($(this).parents('.bootstrap-select'));
      }
    });

    $('.choicepicker').each(function() {
      if($(this).data('sampledb-default')) {
        if($(this).parents('.array-template').length === 0) {
          $(this).selectpicker('val', $(this).data('sampledb-default'));
          $(this).removeAttr('data-sampledb-default');
          $(this).removeData('sampledb-default');
        }
      }
    });

    $('.selectpicker').selectpicker('refresh');
    $('[data-toggle="tooltip"]').tooltip('hide');
  }

  function replaceMarkdownTemplates() {
    $('.template-markdown-editor').each(function(_, element) {
      if($(this).parents('.array-template').length === 0) {
        $(this).removeClass('template-markdown-editor');
        setupImageDragAndDrop(initMarkdownField(element, '100px'));
      }
    });
  }

  function applySchemaCalculations(clone) {
    $(clone).find('.calculation-wrapper').each(function() {
      const id_prefix = $(this).data('id-prefix');
      const schema = $(this).data('schema');
      const root_schema = $(this).data('root-schema');
      window.calculation_scripts.push(function () {
        setUpCalculation(id_prefix, schema, root_schema);
      });
    });
    setUpCalculations();
  }

  function setUpCalculations() {
    if (!window.calculation_scripts) {
      window.calculation_scripts = [];
    }
    $.each(window.calculation_scripts, function () {
      this();
    });
  }

  function applySchemaConditions(clone) {
    $(clone).find('.condition-wrapper').each(function() {
      const id_prefix = $(this).data('id-prefix');
      const conditions = $(this).data('conditions');
      conditionalWrapper(id_prefix, conditions);
    });

    $.each(window.conditionalWrapperScripts, function () {
      this();
    });
    window.conditionalWrapperScripts = [];
  }

  function updateRecipeState(clone) {
    if (!clone[0].id.startsWith('container_')) {
      return;
    }
    const id_prefix = clone[0].id.substring('container_'.length);
    const recipe_div = $(`#${id_prefix}_recipe_div`);
    if (recipe_div.length === 0) {
      return;
    }
    recipe_div.attr('data-toggle', 'tooltip');
    recipe_div.tooltip();
    const recipes = recipe_div.data('sampledb-recipes');
    refreshRecipeTooltip(id_prefix, recipes);
    $(`#${id_prefix}_recipe_input`).on('change', function() {
      refreshRecipeTooltip(id_prefix, recipes);
    }).addClass('selectpicker').selectpicker();
    $(`#${id_prefix}_recipe_button`).on('click', function() {
      applyRecipe(id_prefix, recipes, false);
    });
  }
</script>
{% endblock %}
